name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  markdownlint:
    name: Markdown lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: "**/*.md"

  link-check:
    name: Check links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check internal links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: "yes"
          config-file: ".markdown-link-check.json"
          check-modified-files-only: "yes"

  mermaid-check:
    name: Validate Mermaid diagrams
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Find and validate Mermaid diagrams
        run: |
          # Extract mermaid blocks and validate syntax
          find . -name "*.md" -exec grep -l '```mermaid' {} \; | while read file; do
            echo "Checking $file..."
            # Extract mermaid blocks to temp files and validate
            awk '/```mermaid/,/```/' "$file" | grep -v '```' > /tmp/mermaid-check.mmd
            if [ -s /tmp/mermaid-check.mmd ]; then
              mmdc -i /tmp/mermaid-check.mmd -o /tmp/mermaid-check.svg 2>&1 || {
                echo "Mermaid validation failed in $file"
                exit 1
              }
            fi
          done
